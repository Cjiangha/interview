const app = getApp()

Page({
  data: {
    save_data:[
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈1'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},    
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:01',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
      {time:'2021/10/13 10:21:10',njnqz:'129Nm',sdnqz:'130Nm',hg:'',lsgg:'M18',ttid:'',fjdm:'',czy:'王',xmmc:'哈哈哈哈'},
    ]
  },

  onLoad: function () {
    console.log('this.',this.data.save_data.length)
    wx.createSelectorQuery()
    .select('#canvas')
    .fields({
      node: true,
      size: true,
    })
    .exec(this.init.bind(this))
  },

  init(res) {
    var that=this;
    that.setData({
      rectH:30 * that.data.save_data.length+80,//因表格高度UI说给30px，所以当获取了数据的总行数后，需要重新计算画布的高度。
    });

    const canvas = res[0].node
    console.log('canvas',canvas)
    that.setData({
      canvas:canvas
    })
    const width = res[0].width
    const height = that.data.rectH
    const ctx = canvas.getContext('2d')
    const dpr = wx.getSystemInfoSync().pixelRatio
    canvas.width = width * dpr
    canvas.height = height * dpr
    ctx.scale(dpr, dpr)
    ctx.lineWidth = 0.5;

    ctx.fillStyle='white';
    ctx.fillRect(0,0,canvas.width,canvas.height)

    ctx.beginPath();
    ctx.fillStyle='black';
    var save_data=that.data.save_data;
    console.log('save_data',save_data)
    for(var i=0;i<save_data.length;i++){
      if(i==0){
        ctx.moveTo(10,10);
        ctx.lineTo(710,10);
        ctx.moveTo(10,40);
        ctx.lineTo(710,40);
        ctx.fillText('时间', 12, 28)
        ctx.fillText('项目名称', 112, 28)
        ctx.fillText('拧紧扭矩值(Nm)', 212, 28)
        ctx.fillText('设定扭矩值(Nm)', 312, 28)
        ctx.fillText('合格', 412, 28)
        ctx.fillText('螺栓规格', 472, 28)
        ctx.fillText('套筒ID', 532, 28)
        ctx.fillText('风机代码', 592, 28)
        ctx.fillText('操作员', 652, 28)
      }
      ctx.moveTo(10,30*i+70);
      ctx.lineTo(710,30*i+70);
      ctx.fillText(save_data[i].time, 12, 30*i+60)
      ctx.fillText(save_data[i].xmmc,  112, 30*i+60)
      ctx.fillText(save_data[i].njnqz, 212, 30*i+60)
      ctx.fillText(save_data[i].sdnqz, 312, 30*i+60)
      ctx.fillText(save_data[i].hg,  412, 30*i+60)
      ctx.fillText(save_data[i].lsgg, 472, 30*i+60)
      ctx.fillText(save_data[i].ttid,  532, 30*i+60)
      ctx.fillText(save_data[i].fjdm,  592, 30*i+60)
      ctx.fillText(save_data[i].czy,  652, 30*i+60)
    }
    for(var j=0;j<=9;j++){
      if(j == 0){
        ctx.moveTo(10,10);
        ctx.lineTo(10,30*save_data.length+40);
      }else if(j == 1){
        ctx.moveTo(110,10);
        ctx.lineTo(110,30*save_data.length+40);
      }else if(j == 2){
        ctx.moveTo(210,10);
        ctx.lineTo(210,30*save_data.length+40);
      }else if(j == 3){
        ctx.moveTo(310,10);
        ctx.lineTo(310,30*save_data.length+40);
      }else if(j == 4){
        ctx.moveTo(410,10);
        ctx.lineTo(410,30*save_data.length+40);
      }else{
        ctx.moveTo(230+60*(j-1),10);
        ctx.lineTo(230+60*(j-1),30*save_data.length+40);
      }
    }
    ctx.closePath();
    ctx.strokeStyle = '#2c2c2c';
    ctx.fill();
    ctx.stroke();
    setTimeout(function(){
      wx.canvasToTempFilePath({
        canvas: that.data.canvas,
        success: function (res) {
          console.log('res',res)
          console.log('shareImg',res.tempFilePath)
          that.setData({shareImg: res.tempFilePath})
        },
        fail: function (res) {
            wx.showToast({title: '图片生成失败'});
            console.log("图片生成失败error", res)
        }
      }, this)
    },1000);

  },

  saveImg() {
    let that = this;
    // 获取用户是否开启用户授权相册
    wx.getSetting({
      success(res) {
        // 如果没有则获取授权
        if (!res.authSetting['scope.writePhotosAlbum']) {
          wx.authorize({
            scope: 'scope.writePhotosAlbum',
            success() {
             that.saveSuccess()
            },
            fail() {
              // 如果用户拒绝过或没有授权，则再次打开授权窗口
              that.openPicture()
            }
          })
        } else {
          // 有则直接保存
         that.saveSuccess()
        }
      }
    })
  },
  //保存图片
  saveSuccess(){
    var that=this;
    console.log('shareImg',that.data.shareImg)
     wx.saveImageToPhotosAlbum({
          filePath: that.data.shareImg,
          success(res) {
            console.log('res',res)
             wx.showToast({ title: '保存成功'})
          },
          fail() {wx.showToast({ title: '保存失败'})}
      })
  },
  //打开授权窗口
  openPicture() {
    wx.showModal({
      title: '提示',
      content: '相册系统未授权，请重新授权并保存图片',
      confirmColor: '#1989fa',
      confirmText: '确定',
      success(res) {
        if (res.confirm) {
          wx.openSetting({
            success: (res) => {
              console.log('打开授权页')
            }
          })
        } else if (res.cancel) {
          console.log('用户点击取消')
        }
      }
    })
  },
})
